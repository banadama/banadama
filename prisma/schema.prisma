// Prisma Schema - Banadama MVP
// Complete implementation with all models for B2B marketplace

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  BUYER
  SUPPLIER // Consolidated FACTORY + WHOLESALER
  FACTORY // Legacy - maps to SUPPLIER
  WHOLESALER // Legacy - maps to SUPPLIER
  CREATOR
  OPS
  AFFILIATE
  ADMIN
  FINANCE_ADMIN
  GROWTH_AGENT
  GROWTH_MANAGER
}

enum SupplierType {
  FACTORY
  WHOLESALER
}

enum CreatorType {
  // Digital Creators (Global)
  GRAPHIC_DESIGNER
  MOCK_DESIGNER
  AI_AGENT_DEV

  // Local Service Creators (NG/BD only)
  MODELLING
  PHOTOGRAPHER
  VIDEOGRAPHER
}

enum CreatorListingType {
  DIGITAL
  LOCAL_SERVICE
}

enum CreatorPriceType {
  FIXED
  STARTING_FROM
  QUOTED
}

enum CreatorOrderStatus {
  PENDING
  PAID_ESCROW
  IN_PROGRESS
  DELIVERED
  CONFIRMED
  CANCELLED
  DISPUTED
}

enum VerificationType {
  USER_KYC // Basic ID verification
  SUPPLIER // Factory/Wholesaler business verification
  CREATOR // Creator portfolio verification
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ServiceTier {
  BASIC
  PREMIUM
  BUSINESS
}

enum RequestStatus {
  PENDING // Waiting for Ops assignment
  QUOTED // Quote generated by Ops
  APPROVED // Buyer accepted quote
  REJECTED // Buyer rejected or cancelled
}

enum OrderStatus {
  PENDING // Order created, awaiting payment
  PAID // Payment received, funds in escrow
  PROCESSING // SupplierProfile working on it
  SHIPPED // In transit
  DELIVERED // Buyer received
  CANCELLED // Cancelled before fulfillment
}

enum WalletStatus {
  ACTIVE
  FROZEN
  RESTRICTED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT_ESCROW // Lock funds on order
  PAYMENT_RELEASE // Release to supplier on delivery
  REFUND
  COMMISSION // Affiliate commission
  SUBSCRIPTION_FEE // Service plan fee
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  APPROVED
  PROCESSING
  PAID
  REJECTED
}

enum ConversionType {
  SIGNUP // Not used in sales-only model
  SALE // Sales commission
  VERIFIED_SUPPLIER // SupplierProfile referral bonus
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum ConversationType {
  BUYER_OPS
  SUPPLIER_OPS
  CREATOR_OPS
}

// ============================================
// MULTI-ACCOUNT SYSTEM ENUMS
// ============================================

enum AccountType {
  BUYER
  COMPANY_FACTORY
  COMPANY_WHOLESALER
  COMPANY_RETAIL
  CREATOR_MODEL
  CREATOR_GRAPHIC
  CREATOR_MOCK
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum VerificationLevel {
  NONE
  BLUE // Verified identity (buyers, creators)
  GREEN // Verified business (factories, wholesalers, strong retailers)
  GOLD // Reserved for future use
}

enum MembershipRole {
  OWNER
  STAFF
}

// ============================================
// PRODUCT & LISTING CONTROL ENUMS
// ============================================

enum ProductApprovalStatus {
  PENDING // Awaiting admin approval
  APPROVED // Approved by admin
  REJECTED // Rejected by admin
  CHANGES_REQUIRED // Requires seller changes
}

// ============================================
// DISPUTE & RESOLUTION ENUMS
// ============================================

enum DisputeStatus {
  OPEN
  INVESTIGATING
  RESOLVED_BUYER_FAVOR
  RESOLVED_SUPPLIER_FAVOR
  RESOLVED_PARTIAL
  CLOSED
}

enum DisputeType {
  NON_DELIVERY
  QUALITY_ISSUE
  WRONG_ITEM
  PRICING_DISPUTE
  SHIPPING_DAMAGE
  OTHER
}

enum DisputeResolutionType {
  FULL_REFUND
  PARTIAL_REFUND
  REPLACEMENT
  CREDIT
  NO_ACTION
  OTHER
}

// ============================================
// ADMIN ROLE HIERARCHY ENUMS
// ============================================

enum AdminRoleType {
  SUPER_ADMIN // Full access to everything
  OPS_ADMIN // Operations, disputes, verifications
  CONTENT_ADMIN // Products, categories, CMS
  FINANCE_ADMIN // Payouts, fees, commissions
  SUPPORT_ADMIN // User support, basic access
}

// ============================================
// FINANCE MODE ENUMS
// ============================================

enum EscrowStatus {
  PENDING // Awaiting payment
  LOCKED // Funds locked, awaiting delivery
  PARTIAL_RELEASE // Part released, part held
  RELEASED // Fully released to supplier
  REFUNDED // Returned to buyer
  DISPUTED // Under dispute review
}

enum PayoutApprovalStatus {
  PENDING_VERIFICATION // Delivery not yet confirmed
  PENDING_APPROVAL // Awaiting Finance approval
  APPROVED // Finance approved
  PROCESSING // Payout in progress
  COMPLETED // Paid out
  REJECTED // Finance rejected
  ON_HOLD // Held by Finance
}

enum RefundStatus {
  REQUESTED // Buyer requested
  PENDING_REVIEW // Under review
  APPROVED // Finance approved
  PROCESSING // Refund in progress
  COMPLETED // Refunded
  REJECTED // Denied
}

enum LedgerEntryType {
  DEPOSIT // Money in
  WITHDRAWAL // Money out
  ESCROW_LOCK // Lock for order
  ESCROW_RELEASE // Release to supplier
  ESCROW_REFUND // Return to buyer
  PLATFORM_FEE // Platform commission
  PAYOUT // SupplierProfile payout
  ADJUSTMENT // Manual adjustment
}

// ============================================
// CORE USER MODELS
// ============================================

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  phone        String?    @unique
  passwordHash String? // For users with password auth
  role         Role
  status       UserStatus @default(ACTIVE)
  country      String? // ISO code: "NG", "BD", etc.
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Profile relations (one-to-one)
  buyerProfile     BuyerProfile?
  supplierProfile  SupplierProfile?
  creatorProfile   CreatorProfile?
  affiliateProfile AffiliateProfile?

  // Multi-Account System
  accounts        AccountMembership[]
  activeAccountId String? // Currently active account ID

  // Wallet
  wallet Wallet?

  // Verification
  verificationRequests  VerificationRequest[]
  reviewedVerifications VerificationRequest[] @relation("VerificationReviewedBy")

  // Messaging
  sentMessages  Message[]                 @relation("MessageSender")
  conversations ConversationParticipant[]

  // Admin
  adminActionsPerformed AdminAuditLog[] @relation("AdminUser")
  adminActionsReceived  AdminAuditLog[] @relation("TargetUser")

  // Feature flags and site settings updated by this admin
  featureFlagsUpdated FeatureFlag[] @relation("FeatureFlagUpdatedBy")
  siteSettingsUpdated SiteSetting[] @relation("SiteSettingUpdatedBy")
  accountsVerified    Account[]     @relation("AccountVerifiedBy")

  // Sessions
  sessions UserSession[]

  // Creator Orders
  creatorOrders      CreatorOrder[]      @relation("BuyerCreatorOrders")
  GrowthAgentProfile GrowthAgentProfile?
  pushSubscriptions  PushSubscription[]
}

// ============================================
// MULTI-ACCOUNT SYSTEM MODELS
// ============================================

model Account {
  id      String      @id @default(cuid())
  type    AccountType
  name    String // Company name or profile name
  country String // ISO: "NG", "BD"

  // Verification
  verificationLevel VerificationLevel @default(NONE)
  verifiedAt        DateTime?
  verifiedByAdminId String?
  verifiedByAdmin   User?             @relation("AccountVerifiedBy", fields: [verifiedByAdminId], references: [id])
  verificationNotes String?

  // Status
  isActive Boolean @default(true)

  // ========================================
  // ACCOUNT FREEZE & LIMIT CONTROLS
  // ========================================
  isFrozen        Boolean   @default(false)
  frozenAt        DateTime?
  frozenByAdminId String?
  freezeReason    String?

  // Granular action limits (when account is limited but not fully frozen)
  canCreateOrders Boolean @default(true)
  canRespondToRfq Boolean @default(true)
  canWithdraw     Boolean @default(true)
  canListProducts Boolean @default(true)

  // Limit notes for admin reference
  limitNotes     String?
  limitExpiresAt DateTime? // Auto-expire limits

  // Profile data (JSON for flexibility)
  profileData Json?

  // Relations
  memberships AccountMembership[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  AccountWallet AccountWallet?

  @@index([type])
  @@index([country])
  @@index([verificationLevel])
  @@index([isActive])
  @@index([isFrozen])
}

model AccountMembership {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId String
  account   Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  role      MembershipRole @default(STAFF)

  // When the user joined this account
  joinedAt DateTime @default(now())

  @@unique([userId, accountId])
  @@index([userId])
  @@index([accountId])
}

model SiteSetting {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json // Can store string, number, object, array
  category    String? // Group settings: "platform", "fees", "countries"
  description String?

  updatedByAdminId String?
  updatedByAdmin   User?   @relation("SiteSettingUpdatedBy", fields: [updatedByAdminId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
}

// ============================================
// DISPUTE & RESOLUTION MODEL
// ============================================

model Dispute {
  id      String @id @default(cuid())
  orderId String

  // Parties involved
  buyerId    String
  supplierId String

  // Dispute details
  type        DisputeType
  status      DisputeStatus @default(OPEN)
  description String
  evidence    Json? // URLs, notes, documents

  // Resolution
  resolutionType    DisputeResolutionType?
  resolutionNotes   String?
  resolvedAt        DateTime?
  resolvedByAdminId String?

  // Financial outcome
  refundAmount    Int? // Amount refunded (in kobo)
  supplierPenalty Int? // Penalty charged to supplier (in kobo)
  buyerCredit     Int? // Credit given to buyer (in kobo)

  // Admin notes (internal)
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([buyerId])
  @@index([supplierId])
  @@index([status])
  @@index([type])
}

// ============================================
// PRICING & COMMISSION RULES MODEL
// ============================================

model PricingRule {
  id String @id @default(cuid())

  // Scope (which orders/products this applies to)
  scope      String // "global", "category", "country", "account"
  scopeValue String? // e.g., "fashion-fabrics", "NG", accountId

  // Rule type
  ruleType String // "platform_fee", "buyer_fee", "supplier_fee", "commission"

  // Fee configuration
  feeType  String // "percentage" or "fixed"
  feeValue Float // Percentage (e.g., 5.0 for 5%) or fixed amount (in kobo)

  // Thresholds
  minOrderValue Int? // Minimum order value for this rule to apply (kobo)
  maxOrderValue Int? // Maximum order value for this rule to apply (kobo)

  // Status
  isActive Boolean @default(true)
  priority Int     @default(0) // Higher priority rules override lower ones

  // Admin tracking
  createdByAdminId String?

  // Notes
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scope, scopeValue])
  @@index([ruleType])
  @@index([isActive])
}

// ============================================
// ADMIN ROLE & PERMISSION MODEL
// ============================================

model AdminRole {
  id     String @id @default(cuid())
  userId String @unique

  // Role type
  roleType AdminRoleType @default(SUPPORT_ADMIN)

  // Granular permissions (JSON for flexibility)
  permissions Json? // e.g., { "canManageUsers": true, "canManageDisputes": true }

  // Restrictions
  restrictedTo Json? // e.g., { "countries": ["NG"], "categories": ["fashion"] }

  // Admin tracking
  assignedByAdminId String?
  assignedAt        DateTime @default(now())

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roleType])
}

// ============================================
// MARKET CONTROL MODEL
// ============================================

model MarketControl {
  id String @id @default(cuid())

  // What is being controlled
  controlType String // "country", "category", "feature"
  targetValue String // "NG", "fashion-fabrics", "rfq", "buy_now"

  // Control settings
  isEnabled       Boolean   @default(true)
  isPaused        Boolean   @default(false)
  pauseReason     String?
  pausedAt        DateTime?
  pausedByAdminId String?

  // Schedule (for planned changes)
  scheduledEnableAt  DateTime?
  scheduledDisableAt DateTime?

  // Restrictions within this market
  restrictions Json? // e.g., { "maxOrderValue": 1000000, "requiresApproval": true }

  // Admin notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([controlType, targetValue])
  @@index([controlType])
  @@index([isEnabled])
  @@index([isPaused])
}

// ============================================
// PROFILE MODELS
// ============================================
model BuyerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Buyer details
  companyName    String?
  phoneNumber    String?
  defaultAddress String?
  defaultCity    String?
  defaultCountry String?

  // Relations
  requests         Request[]
  orders           Order[]
  subscription     Subscription?
  pricingOverrides PricingOverride[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SupplierProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // SupplierProfile details
  businessName String?
  type         SupplierType @default(FACTORY)
  phoneNumber  String?
  address      String?
  city         String?

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Relations
  products Product[]
  requests Request[] // Assigned RFQs
  orders   Order[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  GrowthSupplier GrowthSupplier?
  FactoryProfile FactoryProfile?
}

model CreatorProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  displayName      String?
  bio              String?
  country          String? // ISO code: NG, BD
  state            String?
  city             String?
  skills           Json              @default("[]") // skills as per prompt
  verificationTick VerificationLevel @default(NONE)

  // Relations
  listings CreatorListing[]
  orders   CreatorOrder[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Legacy fields
  products Product[]
  jobs     CreatorJob[]

  @@map("creator_profiles")
}

model CreatorListing {
  id        String         @id @default(cuid())
  creatorId String
  creator   CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  type     CreatorListingType
  category String // categories from prompt

  title       String
  description String?
  media       Json             @default("[]") // portfolio images/videos
  priceType   CreatorPriceType @default(FIXED)
  currency    String           @default("USD")
  price       Float?

  country String? // required if LOCAL_SERVICE
  state   String?
  city    String?

  status String @default("ACTIVE") // DRAFT, ACTIVE, PAUSED, ARCHIVED

  orders CreatorOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@map("creator_listings")
}

model CreatorOrder {
  id          String @id @default(cuid())
  buyerUserId String @map("buyer_account_id")
  buyer       User   @relation("BuyerCreatorOrders", fields: [buyerUserId], references: [id])

  creatorId String @map("creator_id")
  creator   CreatorProfile @relation(fields: [creatorId], references: [id])

  listingId String @map("listing_id")
  listing   CreatorListing @relation(fields: [listingId], references: [id])

  type   CreatorListingType
  status CreatorOrderStatus @default(PENDING)

  subtotal Float  @default(0)
  fees     Float  @default(0)
  total    Float  @default(0)
  currency String @default("USD")

  escrowId String? @map("escrow_id")
  threadId String? @map("thread_id")

  serviceDate DateTime? @map("service_date")
  location    Json      @default("{}")

  deliveries CreatorDelivery[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([creatorId])
  @@index([buyerUserId])
  @@index([status])
  @@map("creator_orders")
}

model CreatorDispute {
  id        String @id @default(cuid())
  orderId   String @unique @map("order_id")
  
  status    String @default("OPEN") // OPEN, IN_REVIEW, RESOLVED
  reason    String
  details   String?
  
  assignedOpsAccountId String? @map("assigned_ops_account_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("creator_disputes")
}

model CreatorDisputeEvent {
  id         String @id @default(cuid())
  disputeId  String @map("dispute_id")
  type       String // OPENED, STATUS_CHANGED, RESOLVED, MSG_POSTED
  note       String?
  metadata   Json?
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@map("creator_dispute_events")
}

model CreatorDelivery {
  id      String       @id @default(cuid())
  orderId String       @map("order_id")
  order   CreatorOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  message     String?
  files       Json     @default("[]")
  deliveredAt DateTime @default(now()) @map("delivered_at")
  
  @@map("creator_deliveries")
}

// ============================================
// PRODUCT & REQUEST MODELS
// ============================================

model Product {
  id String @id @default(cuid())

  // Basic info
  name         String
  description  String?
  categorySlug String?
  categoryName String?

  // Pricing
  unitPrice Float
  moq       Int? // Minimum Order Quantity

  // Inventory
  stockQuantity Int?

  // Metadata
  countryOfOrigin String?
  images          String[] @default([])

  // Owner (supplier or creator)
  supplierId String?
  supplier   SupplierProfile? @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  creatorId  String?
  creator    CreatorProfile?  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Settings
  allowRfq      Boolean @default(true)
  allowBuyNow   Boolean @default(true)
  allowGroupBuy Boolean @default(false)
  isActive      Boolean @default(true)

  // ========================================
  // ADMIN PRODUCT CONTROLS
  // ========================================
  approvalStatus    ProductApprovalStatus @default(PENDING)
  approvedAt        DateTime?
  approvedByAdminId String?
  rejectionReason   String?

  // Admin visibility control
  isHiddenByAdmin Boolean   @default(false)
  hiddenReason    String?
  hiddenAt        DateTime?
  hiddenByAdminId String?

  // Flagging for misleading content
  isFlagged        Boolean   @default(false)
  flagReason       String?
  flaggedAt        DateTime?
  flaggedByAdminId String?

  // Price change tracking (requires approval if enabled)
  priceChangeRequiresApproval Boolean @default(false)
  lastApprovedPrice           Float?

  // Relations
  requests Request[]
  orders   Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
  @@index([creatorId])
  @@index([categorySlug])
  @@index([approvalStatus])
  @@index([isHiddenByAdmin])
  @@index([isFlagged])
}

model Request {
  id String @id @default(cuid())

  // Buyer
  buyer   BuyerProfile @relation(fields: [buyerId], references: [id])
  buyerId String

  // Product reference (optional - can create RFQ without specific product)
  product     Product? @relation(fields: [productId], references: [id])
  productId   String?
  productName String // Even if no product, we need the name

  // Request details
  quantity       Int
  targetPrice    Float? // Buyer's target price per unit
  description    String?
  specifications String? // JSON or text

  // Category for pricing calculations
  categorySlug String?

  // Delivery
  deliveryAddress String
  deliveryCity    String?
  deliveryCountry String  @default("NG")

  // Service tier
  serviceTier ServiceTier @default(BASIC)

  // Ops assignment
  supplierId String?
  supplier   SupplierProfile? @relation(fields: [supplierId], references: [id])

  // Quote
  quotedPrice      Float? // Unit price quoted by Ops
  estimatedPricing Json? // Full pricing breakdown from pricing engine
  estimatedTotal   Float? // Grand total

  // Status
  status RequestStatus @default(PENDING)

  // Relations
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerId])
  @@index([supplierId])
  @@index([status])
}

model Order {
  id String @id @default(cuid())

  // Relations
  request   Request? @relation(fields: [requestId], references: [id])
  requestId String?

  buyer   BuyerProfile @relation(fields: [buyerId], references: [id])
  buyerId String

  supplier   SupplierProfile @relation(fields: [supplierId], references: [id])
  supplierId String

  product     Product? @relation(fields: [productId], references: [id])
  productId   String?
  productName String

  // Order details
  quantity        Int
  totalPrice      Float
  currency        String @default("NGN")
  pricingSnapshot Json? // Final pricing breakdown

  // Delivery
  deliveryAddress String
  deliveryCity    String?
  deliveryCountry String  @default("NG")

  // Tracking
  trackingNumber String?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  confirmedAt    DateTime? // When buyer confirms delivery

  // Status
  status OrderStatus @default(PENDING)

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  Escrow             Escrow?
  FinancePayout      FinancePayout[]
  FinanceRefund      FinanceRefund[]
  InternationalOrder InternationalOrder?
  Shipment           Shipment?
  FactoryProduction  FactoryProduction?

  @@index([buyerId])
  @@index([supplierId])
  @@index([status])
}

// ============================================
// WALLET & TRANSACTIONS
// ============================================

model Wallet {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance       Int          @default(0) // Available balance (in kobo)
  lockedBalance Int          @default(0) // In escrow
  currency      String       @default("NGN")
  status        WalletStatus @default(ACTIVE)

  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transaction {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  amount      Int // In kobo (can be negative)
  type        TransactionType
  status      TransactionStatus @default(PENDING)
  reference   String? // External ref or order ID
  description String?
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([reference])
}

// ============================================
// CREATOR JOBS (Local Service Creators)
// ============================================

model CreatorJob {
  id String @id @default(cuid())

  creator   CreatorProfile @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId String

  // Job details
  title       String
  description String
  clientName  String?
  location    String

  // Schedule
  scheduledDate DateTime
  duration      Int? // In hours

  // Payment
  payment Int // In kobo

  // Status
  status String @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([status])
}

// ============================================
// MESSAGING / CHAT SYSTEM
// ============================================

model Conversation {
  id String @id @default(cuid())

  type  ConversationType
  title String?

  // Participants
  participants ConversationParticipant[]
  messages     Message[]

  // Metadata
  isActive      Boolean   @default(true)
  lastMessageAt DateTime?

  // Dispute link
  disputeId String? @map("dispute_id")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([isActive])
  @@map("chat_threads")
}

model PushSubscription {
  id        String @id @default(cuid())
  userId    String @map("account_id")
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String @unique
  p256dh    String
  auth      String
  userAgent String? @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("push_subscriptions")
}

model ConversationParticipant {
  id String @id @default(cuid())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String       @map("thread_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("account_id")

  // Read tracking
  lastReadAt  DateTime? @map("last_read_at")
  unreadCount Int       @default(0) @map("unread_count")

  joinedAt DateTime @default(now()) @map("joined_at")

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([userId, lastReadAt])
  @@map("chat_thread_reads")
}

model Message {
  id String @id @default(cuid())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String       @map("thread_id")

  sender   User   @relation("MessageSender", fields: [senderId], references: [id])
  senderId String @map("sender_account_id")

  content     String
  attachments String[] @default([])

  status MessageStatus @default(SENT)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ============================================
// AFFILIATE SYSTEM
// ============================================

model AffiliateClick {
  id String @id @default(cuid())

  link   AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  linkId String

  ipAddress String?
  userAgent String?
  referer   String?
  country   String?

  clickedAt DateTime @default(now())

  @@index([linkId])
  @@index([clickedAt])
}

model AffiliateConversion {
  id String @id @default(cuid())

  affiliate   AffiliateProfile @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  affiliateId String

  link   AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  linkId String

  type ConversionType // SALE, VERIFIED_SUPPLIER (no SIGNUP)

  userId     String?
  orderId    String?
  supplierId String?

  commissionAmount Int
  commissionRate   Float?
  currency         String @default("NGN")

  paid   Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())

  @@index([affiliateId])
  @@index([linkId])
  @@index([type])
  @@index([paid])
}

// ============================================
// VERIFICATION SYSTEM
// ============================================

model VerificationRequest {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   VerificationType
  status VerificationStatus @default(PENDING)

  supplierId String?
  creatorId  String?

  data         Json?
  documentUrls String[] @default([])

  reviewedById    String?
  reviewedBy      User?     @relation("VerificationReviewedBy", fields: [reviewedById], references: [id])
  reviewedAt      DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type, status])
  @@index([userId])
}

// ============================================
// SERVICE PLANS & SUBSCRIPTIONS
// ============================================

model ServicePlan {
  id          String      @id @default(cuid())
  tier        ServiceTier @unique
  name        String
  price       Int // In kobo
  description String
  features    String[]    @default([])

  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id      String       @id @default(cuid())
  buyerId String       @unique
  buyer   BuyerProfile @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  planId String
  plan   ServicePlan @relation(fields: [planId], references: [id])

  active    Boolean   @default(true)
  startDate DateTime  @default(now())
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerId])
  @@index([active])
}

// ============================================
// ADMIN SYSTEM
// ============================================

model AdminAuditLog {
  id String @id @default(cuid())

  admin   User   @relation("AdminUser", fields: [adminId], references: [id])
  adminId String

  action String

  targetType   String
  targetId     String
  targetUser   User?   @relation("TargetUser", fields: [targetUserId], references: [id])
  targetUserId String?

  before   Json?
  after    Json?
  metadata Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([action])
  @@index([createdAt])
}

model SystemConfig {
  id String @id @default(cuid())

  key         String  @unique
  value       Json
  category    String
  description String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([key])
}

model PricingOverride {
  id String @id @default(cuid())

  buyer   BuyerProfile? @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  buyerId String?
  segment String?

  overrideType String

  serviceFee      Int?
  fulfillmentRate Float?
  dutyMargin      Float?

  minOrderValue Int?
  maxOrderValue Int?
  category      String?
  region        String?

  reason    String?
  isActive  Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerId])
  @@index([segment])
  @@index([isActive])
}

model FeatureFlag {
  id String @id @default(cuid())

  key     String  @unique
  enabled Boolean @default(false)

  rolloutPercentage Int      @default(0)
  allowedRoles      String[]

  name        String
  description String?
  category    String?

  // Track who updated this flag
  updatedByAdminId String?
  updatedByAdmin   User?   @relation("FeatureFlagUpdatedBy", fields: [updatedByAdminId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([enabled])
}

model UserSession {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  token     String  @unique
  ipAddress String?
  userAgent String?
  device    String?
  location  String?

  isActive     Boolean  @default(true)
  lastActivity DateTime @default(now())
  expiresAt    DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@index([expiresAt])
}

// ============================================

// FINANCE MODE MODELS

// ============================================

model AccountWallet {
  id String @id @default(cuid())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  accountId String @unique

  // Balances (stored in kobo/smallest unit)

  availableBalance Int @default(0)

  lockedBalance Int @default(0) // In escrow

  pendingBalance Int @default(0) // Pending payouts

  // Wallet status

  status WalletStatus @default(ACTIVE)

  frozenAt DateTime?

  frozenReason String?

  frozenByAdminId String?

  // Audit

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  ledgerEntries LedgerEntry[]

  @@index([accountId])
  @@index([status])
}

model PlatformWallet {
  id String @id @default(cuid())

  walletType String @unique // "MAIN", "FEES", "ESCROW_POOL"

  balance Int @default(0)

  description String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt
}

model LedgerEntry {
  id String @id @default(cuid())

  wallet AccountWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  walletId String

  type LedgerEntryType

  // Amounts (positive for credit, negative for debit)

  amount Int

  balanceBefore Int

  balanceAfter Int

  // Reference

  referenceType String? // "ORDER", "ESCROW", "PAYOUT", "REFUND"

  referenceId String?

  description String?

  metadata Json?

  // Audit

  createdByAdminId String?

  createdByReason String? // Required for adjustments

  createdAt DateTime @default(now())

  @@index([walletId])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdAt])
}

model Escrow {
  id String @id @default(cuid())

  order Order @relation(fields: [orderId], references: [id])

  orderId String @unique

  buyerAccountId String

  supplierAccountId String

  // Amounts (stored in kobo)

  totalAmount Int // Total locked

  releasedAmount Int @default(0)

  refundedAmount Int @default(0)

  platformFeeAmount Int @default(0)

  status EscrowStatus @default(PENDING)

  // Delivery confirmation

  deliveryConfirmedAt DateTime?

  deliveryConfirmedBy String? // "BUYER", "OPS"

  deliveryProofUrl String?

  // Finance actions

  lockedAt DateTime?

  releasedAt DateTime?

  refundedAt DateTime?

  // Admin tracking

  releaseApprovedByAdminId String?

  releaseApprovedAt DateTime?

  releaseNotes String?

  holdReason String?

  holdByAdminId String?

  holdAt DateTime?

  // Audit

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  payouts FinancePayout[]

  refunds FinanceRefund[]

  @@index([orderId])
  @@index([buyerAccountId])
  @@index([supplierAccountId])
  @@index([status])
}

model FinancePayout {
  id String @id @default(cuid())

  escrow Escrow @relation(fields: [escrowId], references: [id])

  escrowId String

  order Order @relation(fields: [orderId], references: [id])

  orderId String

  supplierAccountId String

  // Amounts

  grossAmount Int // Before fees

  platformFee Int // Fee deducted

  netAmount Int // Actual payout

  status PayoutApprovalStatus @default(PENDING_VERIFICATION)

  // Ops recommendation

  opsRecommendation String? // "RELEASE", "HOLD", "PARTIAL"

  opsRecommendedByUserId String?

  opsRecommendedAt DateTime?

  opsNotes String?

  // Finance decision (FINANCE_ADMIN only)

  approvedByAdminId String?

  approvedAt DateTime?

  approvalNotes String?

  rejectedByAdminId String?

  rejectedAt DateTime?

  rejectionReason String?

  // Payout execution

  processedAt DateTime?

  paymentReference String?

  paymentMethod String?

  // Audit

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([escrowId])
  @@index([orderId])
  @@index([supplierAccountId])
  @@index([status])
}

model FinanceRefund {
  id String @id @default(cuid())

  escrow Escrow @relation(fields: [escrowId], references: [id])

  escrowId String

  order Order @relation(fields: [orderId], references: [id])

  orderId String

  buyerAccountId String

  // Amounts

  requestedAmount Int

  approvedAmount Int?

  status RefundStatus @default(REQUESTED)

  reason String

  category String? // "NON_DELIVERY", "QUALITY", etc.

  // Dispute link

  disputeId String?

  // Finance decision

  approvedByAdminId String?

  approvedAt DateTime?

  approvalNotes String?

  rejectedByAdminId String?

  rejectedAt DateTime?

  rejectionReason String?

  // Execution

  processedAt DateTime?

  refundReference String?

  // Audit

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([escrowId])
  @@index([orderId])
  @@index([buyerAccountId])
  @@index([status])
}

// ============================================

// AFFILIATE MODE ENUMS

// ============================================

enum AffiliateStatus {
  PENDING // Application submitted

  ACTIVE // Approved and active

  SUSPENDED // Temporarily suspended

  BANNED // Permanently banned
}

enum AffiliateSaleStatus {
  PENDING // Order placed, awaiting delivery

  ESCROW_LOCKED // Payment in escrow

  DELIVERED // Delivery confirmed, earning unlocked

  PAID // Commission paid to affiliate

  CANCELLED // Order cancelled, no commission

  DISPUTED // Under dispute
}

enum AffiliatePayoutStatus {
  PENDING // Requested by affiliate

  PENDING_FINANCE // Awaiting FINANCE_ADMIN approval

  APPROVED // Approved by Finance

  PROCESSING // Being processed

  COMPLETED // Paid out

  REJECTED // Rejected by Finance
}

// ============================================

// AFFILIATE MODE MODELS

// ============================================

model AffiliateProfile {
  id String @id @default(cuid())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  userId String @unique

  // Profile info

  displayName String?

  bio String?

  website String?

  // Status

  status AffiliateStatus @default(PENDING)

  approvedAt DateTime?

  approvedByAdminId String?

  suspendedAt DateTime?

  suspendReason String?

  suspendedByAdminId String?

  // Stats (denormalized for performance)

  totalClicks Int @default(0)

  totalSales Int @default(0)

  totalEarnings Int @default(0) // In kobo

  pendingEarnings Int @default(0) // Unlocked but not withdrawn

  paidEarnings Int @default(0) // Already paid out

  // Commission rate (override from global, null = use global)

  customCommissionRate Float?

  // Relations

  links AffiliateLink[]

  sales AffiliateSale[]

  payouts AffiliatePayout[]

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  AffiliateConversion AffiliateConversion[]

  @@index([status])
  @@index([userId])
}

model AffiliateLink {
  id String @id @default(cuid())

  affiliate AffiliateProfile @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  affiliateId String

  // Tracking

  trackingCode String @unique

  // Target (what this link points to)

  targetType String // "PRODUCT", "SUPPLIER", "CATEGORY", "MARKETPLACE"

  targetId String? // Product/SupplierProfile/Category ID if applicable

  // Custom URL parameters

  customParams Json?

  name String? // Friendly name for the link

  // Stats

  clicks Int @default(0)

  uniqueClicks Int @default(0)

  sales Int @default(0)

  earnings Int @default(0) // In kobo

  isActive Boolean @default(true)

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  affiliateSales AffiliateSale[]

  AffiliateClick      AffiliateClick[]
  AffiliateConversion AffiliateConversion[]

  @@index([affiliateId])
  @@index([trackingCode])
  @@index([targetType, targetId])
}

model AffiliateSale {
  id String @id @default(cuid())

  affiliate AffiliateProfile @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  affiliateId String

  link AffiliateLink? @relation(fields: [linkId], references: [id])

  linkId String?

  // Order reference

  orderId String

  orderAmount Int // Order total in kobo

  // Buyer (for self-referral detection)

  buyerId String

  // Commission calculation

  commissionRate Float // Rate at time of sale (e.g., 0.05 = 5%)

  commissionAmount Int // In kobo

  status AffiliateSaleStatus @default(PENDING)

  // Timeline

  orderCreatedAt DateTime

  deliveryConfirmedAt DateTime?

  earningUnlockedAt DateTime?

  paidAt DateTime?

  // If cancelled/disputed

  cancelledAt DateTime?

  cancelReason String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([affiliateId])
  @@index([orderId])
  @@index([status])
}

model AffiliatePayout {
  id String @id @default(cuid())

  affiliate AffiliateProfile @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  affiliateId String

  amount Int // In kobo

  status AffiliatePayoutStatus @default(PENDING)

  // Finance approval

  submittedAt DateTime @default(now())

  approvedByAdminId String?

  approvedAt DateTime?

  rejectedByAdminId String?

  rejectedAt DateTime?

  rejectionReason String?

  // Payment execution

  processedAt DateTime?

  paymentMethod String?

  paymentReference String?

  // Audit

  notes String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([affiliateId])
  @@index([status])
}

model AffiliateSettings {
  id String @id @default(cuid())

  // Global commission rate (default for all affiliates)

  defaultCommissionRate Float @default(0.05) // 5%

  // Category-specific rates

  categoryRates Json? // { "fashion-fabrics": 0.07, "packaging": 0.04 }

  // Minimum payout

  minimumPayout Int @default(500000) // â ¦5,000 in kobo

  // Self-referral protection

  blockSelfReferral Boolean @default(true)

  // Cookie duration (days)

  cookieDuration Int @default(30)

  // Is affiliate program enabled

  isEnabled Boolean @default(true)

  // Who can join

  requireApproval Boolean @default(true)

  updatedAt DateTime @updatedAt

  updatedByAdminId String?
}

// ============================================

// INTERNATIONAL TRADE MODE ENUMS

// ============================================

enum TradeMode {
  LOCAL // NG + BD internal trade

  INTERNATIONAL_BUY_ONLY // Global buyers, no selling
}

enum TradeCountryStatus {
  ENABLED // Can buy from platform

  DISABLED // Blocked

  PENDING // Under review
}

enum InternationalOrderStatus {
  PENDING_REVIEW // Awaiting Ops review

  DOCS_REQUIRED // Waiting for trade documents

  DOCS_SUBMITTED // Documents uploaded

  DOCS_APPROVED // Ops approved documents

  SHIPPING_ARRANGED // Shipping method selected

  IN_TRANSIT // Shipped, in transit

  CUSTOMS_CLEARANCE // At customs

  DELIVERED // Buyer received

  COMPLETED // Finance released payout

  CANCELLED // Cancelled

  DISPUTED // Under dispute
}

enum TradeDocumentType {
  COMMERCIAL_INVOICE

  PACKING_LIST

  CERTIFICATE_OF_ORIGIN

  CUSTOMS_DECLARATION

  EXPORT_LICENSE

  IMPORT_PERMIT

  OTHER
}

enum TradeDocumentStatus {
  PENDING

  APPROVED

  REJECTED

  EXPIRED
}

enum ShippingMethod {
  AIR

  SEA

  ROAD

  COURIER
}

// ============================================

// INTERNATIONAL TRADE MODE MODELS

// ============================================

model TradeCountry {
  id String @id @default(cuid())

  code String @unique // ISO 3166-1 alpha-2 (e.g., "US", "UK")

  name String

  region String? // "EUROPE", "ASIA", "AMERICAS", etc.

  status TradeCountryStatus @default(DISABLED)

  // Trade rules

  allowBuyNow Boolean @default(true)

  allowRfq Boolean @default(true)

  requireDocsReview Boolean @default(true)

  // Allowed categories (null = all allowed)

  allowedCategories String[] @default([])

  blockedCategories String[] @default([])

  // Shipping requirements

  shippingMethods ShippingMethod[] @default([AIR, SEA])

  // Buyer verification requirements

  requireBlueTick Boolean @default(false)

  highValueThreshold Int? // Above this, require BLUE tick (in kobo)

  // Documents typically required

  requiredDocuments TradeDocumentType[] @default([COMMERCIAL_INVOICE, PACKING_LIST])

  // FX settings

  defaultCurrency String @default("USD")

  // Admin tracking

  enabledAt DateTime?

  enabledByAdminId String?

  disabledAt DateTime?

  disabledByAdminId String?

  disableReason String?

  notes String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  orders InternationalOrder[]

  @@index([code])
  @@index([status])
}

model InternationalOrder {
  id String @id @default(cuid())

  // Link to main order

  order Order @relation(fields: [orderId], references: [id])

  orderId String @unique

  // Trade country

  buyerCountry TradeCountry @relation(fields: [buyerCountryCode], references: [code])

  buyerCountryCode String

  // Trade mode

  tradeMode TradeMode @default(INTERNATIONAL_BUY_ONLY)

  // Status

  status InternationalOrderStatus @default(PENDING_REVIEW)

  // Verification requirements met

  supplierGreenTick Boolean @default(false)

  buyerBlueTick Boolean @default(false)

  // FX snapshot at order time

  originalCurrency String // Buyer's currency

  originalAmount Int // Amount in buyer's currency

  convertedAmount Int // Amount in platform currency (NGN)

  fxRate Float // Exchange rate used

  fxSnapshotAt DateTime // When rate was captured

  // Ops assignment

  assignedOpsId String?

  assignedAt DateTime?

  // Timeline

  docsSubmittedAt DateTime?

  docsApprovedAt DateTime?

  docsApprovedByOpsId String?

  shippingArrangedAt DateTime?

  shippedAt DateTime?

  customsClearanceAt DateTime?

  deliveredAt DateTime?

  completedAt DateTime?

  // Notes

  opsNotes String?

  internalNotes String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  documents TradeDocument[]

  shipment TradeShipment?

  @@index([orderId])
  @@index([buyerCountryCode])
  @@index([status])
  @@index([assignedOpsId])
}

model TradeDocument {
  id String @id @default(cuid())

  internationalOrder InternationalOrder @relation(fields: [internationalOrderId], references: [id], onDelete: Cascade)

  internationalOrderId String

  type TradeDocumentType

  name String

  fileUrl String

  status TradeDocumentStatus @default(PENDING)

  // Review

  reviewedByOpsId String?

  reviewedAt DateTime?

  reviewNotes String?

  rejectionReason String?

  // Expiry (for certificates)

  expiresAt DateTime?

  // Metadata

  metadata Json?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([internationalOrderId])
  @@index([type])
  @@index([status])
}

model TradeShipment {
  id String @id @default(cuid())

  internationalOrder InternationalOrder @relation(fields: [internationalOrderId], references: [id], onDelete: Cascade)

  internationalOrderId String @unique

  // Shipping details

  method ShippingMethod

  carrier String?

  trackingNumber String?

  // Timeline

  estimatedDeparture DateTime?

  actualDeparture DateTime?

  estimatedArrival DateTime?

  actualArrival DateTime?

  // Addresses

  originPort String?

  destinationPort String?

  deliveryAddress String

  // Costs (in kobo)

  shippingCost Int?

  insuranceCost Int?

  dutiesEstimate Int?

  // Status updates

  currentLocation String?

  lastUpdateAt DateTime?

  // Notes

  specialInstructions String?

  // Arranged by

  arrangedByOpsId String?

  arrangedAt DateTime?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([trackingNumber])
}

model FXSnapshot {
  id String @id @default(cuid())

  fromCurrency String // e.g., "USD"

  toCurrency String // e.g., "NGN"

  rate Float // e.g., 1500.0 (1 USD = 1500 NGN)

  source String? // Rate source

  validFrom DateTime

  validUntil DateTime?

  createdAt DateTime @default(now())

  @@index([fromCurrency, toCurrency])
  @@index([validFrom])
}

model TradeSettings {
  id String @id @default(cuid())

  // Global trade settings

  internationalEnabled Boolean @default(false)

  // Default requirements

  requireGreenTickSupplier Boolean @default(true)

  defaultHighValueThreshold Int @default(50000000) // â ¦500,000

  // Supported source countries (where suppliers are)

  sourceCountries String[] @default(["NG", "BD"])

  updatedAt DateTime @updatedAt

  updatedByAdminId String?
}

// ============================================

// LOGISTICS MODE ENUMS

// ============================================

enum DeliveryType {
  LOCAL_DELIVERY

  INTERNATIONAL_DELIVERY
}

enum ShipmentStatus {
  PENDING // Shipment created, not yet picked up

  PICKED_UP // Carrier has picked up

  IN_TRANSIT // On the way

  OUT_FOR_DELIVERY // Final mile

  DELIVERED // Delivered to recipient

  FAILED // Delivery failed

  RETURNED // Returned to sender
}

enum ProofOfDeliveryType {
  PHOTO // Photo of delivered package

  SIGNATURE // Customer signature

  DOCUMENT // Signed receipt document

  OTHER
}

// ============================================

// LOGISTICS MODE MODELS

// ============================================

model Shipment {
  id String @id @default(cuid())

  // Link to order

  order Order @relation(fields: [orderId], references: [id])

  orderId String @unique

  // Delivery type

  type DeliveryType @default(LOCAL_DELIVERY)

  // Carrier details (Phase 1 = manual entry)

  carrierName String?

  trackingNumber String?

  trackingUrl String?

  // Status

  status ShipmentStatus @default(PENDING)

  // Timeline

  estimatedPickup DateTime?

  actualPickup DateTime?

  estimatedDelivery DateTime?

  actualDelivery DateTime?

  // Address

  pickupAddress String?

  deliveryAddress String

  // Costs

  shippingCost Int? // In kobo

  insuranceCost Int?

  // Contact info

  recipientName String?

  recipientPhone String?

  // Notes

  specialInstructions String?

  internalNotes String?

  // Delivery confirmation

  deliveryConfirmed Boolean @default(false)

  confirmedByBuyer Boolean @default(false)

  confirmedByOps Boolean @default(false)

  confirmedAt DateTime?

  // Created/managed by

  createdByOpsId String

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  events ShipmentEvent[]

  proofOfDelivery ProofOfDelivery[]

  @@index([orderId])
  @@index([status])
  @@index([trackingNumber])
}

model ShipmentEvent {
  id String @id @default(cuid())

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  shipmentId String

  // Event details

  status ShipmentStatus

  location String?

  note String?

  // Who created

  createdByUserId String?

  createdByRole String? // "OPS", "SYSTEM", "CARRIER"

  timestamp DateTime @default(now())

  @@index([shipmentId])
  @@index([timestamp])
}

model ProofOfDelivery {
  id String @id @default(cuid())

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  shipmentId String

  type ProofOfDeliveryType

  fileUrl String

  fileName String?

  // Metadata

  description String?

  geoLocation String? // Lat,Lng if captured

  capturedAt DateTime?

  // Verification

  verifiedByOpsId String?

  verifiedAt DateTime?

  isValid Boolean @default(false)

  rejectionReason String?

  uploadedByUserId String

  uploadedByRole String // "CARRIER", "OPS", "SUPPLIER"

  uploadedAt DateTime @default(now())

  @@index([shipmentId])
}

model LogisticsSettings {
  id String @id @default(cuid())

  // Global enable/disable

  logisticsEnabled Boolean @default(true)

  // Delivery requirements

  requireProofOfDelivery Boolean @default(true)

  requireBuyerConfirmation Boolean @default(false) // If true, buyer must confirm

  autoVerifyAfterDays Int? // Auto-verify if buyer doesn't respond (null = disabled)

  // Default carriers

  defaultLocalCarrier String?

  defaultIntlCarrier String?

  // Blocked carriers

  blockedCarriers String[] @default([])

  updatedAt DateTime @updatedAt

  updatedByAdminId String?
}

// ============================================

// GROWTH MODE ENUMS

// ============================================

enum GrowthRole {
  GROWTH_AGENT // Field/on-ground agent

  GROWTH_MANAGER // Supervises agents
}

enum GrowthAgentStatus {
  PENDING // Awaiting approval

  ACTIVE // Can onboard suppliers

  SUSPENDED // Temporarily blocked

  TERMINATED // Permanently removed
}

enum GrowthEarningType {
  SUPPLIER_ONBOARD // Per active supplier

  SUPPLIER_FIRST_ORDER // When supplier gets first order

  ORDER_COMMISSION // Per completed order

  BONUS // Manual bonus
}

enum GrowthEarningStatus {
  PENDING // Awaiting activity threshold

  UNLOCKED // Activity met, can be paid

  PAID // Paid out

  REVERSED // Reversed by admin
}

enum GrowthPayoutStatus {
  PENDING // Awaiting Finance

  PENDING_FINANCE // Submitted for Finance approval

  APPROVED // Approved by Finance

  PROCESSING // Being processed

  COMPLETED // Paid

  REJECTED // Rejected
}

// ============================================

// GROWTH MODE MODELS

// ============================================

model GrowthAgentProfile {
  id String @id @default(cuid())

  // Link to user

  user User @relation(fields: [userId], references: [id])

  userId String @unique

  // Role

  role GrowthRole @default(GROWTH_AGENT)

  status GrowthAgentStatus @default(PENDING)

  // Display info

  displayName String?

  phone String?

  region String? // Geographic region assigned

  territory String? // Specific area/market

  // Manager (if agent)

  managerId String?

  // Stats (denormalized for performance)

  totalSuppliersOnboarded Int @default(0)

  activeSuppliersCount Int @default(0)

  totalOrdersGenerated Int @default(0)

  totalEarnings Int @default(0) // In kobo

  pendingEarnings Int @default(0)

  paidEarnings Int @default(0)

  // Commission rate override (null = use default)

  customCommissionRate Float?

  // Approval/Status tracking

  approvedAt DateTime?

  approvedByAdminId String?

  suspendedAt DateTime?

  suspendedByAdminId String?

  suspendReason String?

  // Notes

  internalNotes String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  onboardedSuppliers GrowthSupplier[]

  earnings GrowthEarning[]

  payouts GrowthPayout[]

  @@index([userId])
  @@index([status])
  @@index([managerId])
  @@index([region])
}

model GrowthSupplier {
  id String @id @default(cuid())

  // The onboarded supplier

  supplier SupplierProfile @relation(fields: [supplierId], references: [id])

  supplierId String @unique

  // Who onboarded them

  agent GrowthAgentProfile @relation(fields: [agentId], references: [id])

  agentId String

  // Onboarding status

  onboardedAt DateTime @default(now())

  activatedAt DateTime? // When supplier made first product live

  firstOrderAt DateTime? // When supplier got first order

  firstCompletedOrderAt DateTime? // When first order completed

  // Activity metrics (for commission unlock)

  totalProducts Int @default(0)

  totalOrders Int @default(0)

  completedOrders Int @default(0)

  // Verification status (from supplier)

  verificationLevel String? // NONE, BLUE, GREEN

  // Notes

  onboardingNotes String?

  @@index([agentId])
  @@index([supplierId])
}

model GrowthEarning {
  id String @id @default(cuid())

  agent GrowthAgentProfile @relation(fields: [agentId], references: [id])

  agentId String

  type GrowthEarningType

  amount Int // In kobo

  status GrowthEarningStatus @default(PENDING)

  // Reference (what triggered this earning)

  refType String? // "SUPPLIER" / "ORDER"

  refId String? // supplier ID or order ID

  // Description

  description String?

  // Unlock conditions

  unlockRequirement String? // e.g., "3_COMPLETED_ORDERS"

  unlockProgress Int? // e.g., 2 out of 3

  unlockTarget Int? // e.g., 3

  unlockedAt DateTime?

  // Reversal (if applicable)

  reversedAt DateTime?

  reversedByAdminId String?

  reversalReason String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([status])
  @@index([type])
}

model GrowthPayout {
  id String @id @default(cuid())

  agent GrowthAgentProfile @relation(fields: [agentId], references: [id])

  agentId String

  amount Int // In kobo

  status GrowthPayoutStatus @default(PENDING)

  // Submission

  submittedAt DateTime @default(now())

  // Finance review

  reviewedByFinanceId String?

  reviewedAt DateTime?

  approvalNotes String?

  rejectionReason String?

  // Completion

  completedAt DateTime?

  paymentReference String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([status])
}

model GrowthSettings {
  id String @id @default(cuid())

  // Global enable/disable

  growthModeEnabled Boolean @default(true)

  // Commission rates

  supplierOnboardCommission Int @default(50000) // â ¦500 per active supplier

  firstOrderCommission Int @default(100000) // â ¦1000 when supplier gets first order

  orderCommissionRate Float @default(0.005) // 0.5% per completed order

  // Unlock requirements

  ordersRequiredToUnlock Int @default(1) // Orders needed to unlock onboard commission

  // Payout settings

  minimumPayout Int @default(500000) // â ¦5,000 minimum

  // Fraud controls

  blockSelfOnboard Boolean @default(true) // Agent can't onboard self

  updatedAt DateTime @updatedAt

  updatedByAdminId String?
}

// ============================================

// ANALYTICS & AI MODE ENUMS

// ============================================

enum SnapshotPeriod {
  DAILY

  WEEKLY

  MONTHLY
}

enum InsightStatus {
  ACTIVE // Currently relevant

  ACKNOWLEDGED // Admin has seen it

  DISMISSED // Admin chose to ignore

  ACTED_UPON // Admin took action

  EXPIRED // No longer relevant
}

enum InsightPriority {
  LOW

  MEDIUM

  HIGH

  CRITICAL
}

enum AIAgentType {
  MARKET_AI

  SUPPLIER_AI

  BUYER_AI

  OPS_AI

  PRICING_AI

  FINANCE_AI
}

// ============================================

// ANALYTICS DATA MODELS

// ============================================

model AnalyticsSnapshot {
  id String @id @default(cuid())

  period SnapshotPeriod

  periodStart DateTime

  periodEnd DateTime

  // Market metrics

  totalRfqs Int @default(0)

  totalOrders Int @default(0)

  totalGmv Int @default(0) // Gross Merchandise Value in kobo

  totalPlatformRevenue Int @default(0)

  // Category breakdown (JSON)

  categoryMetrics Json? // { "textiles": { rfqs: 10, orders: 5, gmv: 100000 } }

  // Country breakdown

  nigeriaGmv Int @default(0)

  bangladeshGmv Int @default(0)

  internationalGmv Int @default(0)

  // Order breakdown

  buyNowOrders Int @default(0)

  rfqOrders Int @default(0)

  // User metrics

  newSuppliers Int @default(0)

  newBuyers Int @default(0)

  activeSuppliers Int @default(0)

  activeBuyers Int @default(0)

  // Conversion

  rfqToOrderRate Float?

  avgOrderValue Int?

  createdAt DateTime @default(now())

  @@unique([period, periodStart])
  @@index([period])
  @@index([periodStart])
}

model SupplierScore {
  id String @id @default(cuid())

  supplierId String @unique

  // Performance scores (0-100)

  overallScore Int @default(50)

  responseTimeScore Int @default(50) // How fast they respond to RFQs

  fulfillmentScore Int @default(50) // Order completion rate

  qualityScore Int @default(50) // Based on reviews/disputes

  reliabilityScore Int @default(50) // On-time delivery

  // Raw metrics

  avgResponseTimeHours Float?

  totalOrders Int @default(0)

  completedOrders Int @default(0)

  cancelledOrders Int @default(0)

  disputeRate Float?

  totalRevenue Int @default(0)

  // Flags

  isHighRisk Boolean @default(false)

  isTopPerformer Boolean @default(false)

  riskReasons String[] @default([])

  lastCalculatedAt DateTime @default(now())

  @@index([overallScore])
  @@index([isHighRisk])
  @@index([isTopPerformer])
}

model BuyerScore {
  id String @id @default(cuid())

  buyerId String @unique

  // Behavior scores (0-100)

  overallScore Int @default(50)

  engagementScore Int @default(50)

  conversionScore Int @default(50)

  valueScore Int @default(50)

  // Raw metrics

  totalRfqs Int @default(0)

  convertedRfqs Int @default(0)

  abandonedRfqs Int @default(0)

  totalOrders Int @default(0)

  totalSpent Int @default(0)

  avgOrderValue Int?

  // Flags

  isHighValue Boolean @default(false)

  isAtRisk Boolean @default(false) // Might churn

  lastCalculatedAt DateTime @default(now())

  @@index([overallScore])
  @@index([isHighValue])
}

model OpsMetric {
  id String @id @default(cuid())

  period SnapshotPeriod

  periodStart DateTime

  // RFQ metrics

  avgRfqResponseTimeHours Float?

  rfqsAssigned Int @default(0)

  rfqsCompleted Int @default(0)

  // Order metrics

  avgOrderProcessingHours Float?

  ordersProcessed Int @default(0)

  ordersDelayed Int @default(0)

  // Delivery

  avgDeliveryTimeHours Float?

  deliveriesOnTime Int @default(0)

  deliveriesLate Int @default(0)

  // Chat

  avgChatResponseTimeMinutes Float?

  totalChatsHandled Int @default(0)

  // Per-ops user breakdown (JSON)

  opsUserMetrics Json?

  createdAt DateTime @default(now())

  @@unique([period, periodStart])
  @@index([period])
}

model FinanceMetric {
  id String @id @default(cuid())

  period SnapshotPeriod

  periodStart DateTime

  // Escrow

  escrowLocked Int @default(0)

  escrowReleased Int @default(0)

  escrowBalance Int @default(0)

  // Revenue

  platformFees Int @default(0)

  affiliatePayouts Int @default(0)

  growthPayouts Int @default(0)

  supplierPayouts Int @default(0)

  // Disputes

  refundsIssued Int @default(0)

  refundCount Int @default(0)

  disputesOpened Int @default(0)

  disputesResolved Int @default(0)

  // By category/country (JSON)

  revenueByCategory Json?

  revenueByCountry Json?

  createdAt DateTime @default(now())

  @@unique([period, periodStart])
  @@index([period])
}

// ============================================

// AI INSIGHTS MODEL

// ============================================

model AIInsight {
  id String @id @default(cuid())

  // What generated this

  agentType AIAgentType

  // Insight details

  title String

  description String

  priority InsightPriority @default(MEDIUM)

  status InsightStatus @default(ACTIVE)

  // Target (optional)

  targetType String? // "SUPPLIER", "BUYER", "CATEGORY", "OPS"

  targetId String?

  // Suggested action

  suggestedAction String?

  actionData Json? // Data needed if action is taken

  // Who can see this

  visibleToRoles String[] @default(["ADMIN"])

  // Tracking

  acknowledgedByUserId String?

  acknowledgedAt DateTime?

  dismissedByUserId String?

  dismissedAt DateTime?

  actedUponByUserId String?

  actedUponAt DateTime?

  // Context data

  contextData Json? // Supporting data/charts

  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([agentType])
  @@index([status])
  @@index([priority])
  @@index([visibleToRoles])
}

// ============================================

// FACTORIES MODE ENUMS

// ============================================

enum ProductionStatus {
  NOT_STARTED // Order confirmed, awaiting production

  IN_PRODUCTION // Manufacturing in progress

  QUALITY_CHECK // Quality inspection

  READY_TO_SHIP // Ready for pickup

  SHIPPED // Handed to carrier
}

enum FactoryVerificationStatus {
  PENDING // Awaiting verification

  UNDER_REVIEW // Docs being reviewed

  VERIFIED // Green tick granted

  SUSPENDED // Temporarily blocked

  REJECTED // Verification denied
}

// ============================================

// FACTORY DATA MODELS

// ============================================

model FactoryProfile {
  id String @id @default(cuid())

  // Link to supplier (COMPANY_FACTORY type)

  supplier SupplierProfile @relation(fields: [supplierId], references: [id])

  supplierId String @unique

  // Factory-specific info

  factoryName String

  factoryType String? // e.g., "Garments", "Textiles", "Packaging"

  yearEstablished Int?

  // Location (primarily Bangladesh)

  country String @default("BD") // BD = Bangladesh

  city String?

  address String?

  // Production capabilities

  monthlyCapacityUnits Int? // Max monthly production

  minOrderQuantity Int? // Default MOQ

  standardLeadTimeDays Int? // Default lead time

  // Certifications & compliance

  hasCertifications Boolean @default(false)

  certifications String[] @default([])

  // Verification

  verificationStatus FactoryVerificationStatus @default(PENDING)

  hasGreenTick Boolean @default(false)

  verifiedAt DateTime?

  verifiedByAdminId String?

  // Trade restrictions

  enabledForInternational Boolean @default(false)

  enabledForBuyNow Boolean @default(false) // Samples only

  // Admin notes

  adminNotes String?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  // Relations

  capabilities FactoryCapability[]

  complianceDocs FactoryComplianceDoc[]

  productions FactoryProduction[]

  @@index([supplierId])
  @@index([country])
  @@index([hasGreenTick])
  @@index([verificationStatus])
}

model FactoryCapability {
  id String @id @default(cuid())

  factory FactoryProfile @relation(fields: [factoryId], references: [id])

  factoryId String

  // Capability details

  categorySlug String // e.g., "t-shirts", "packaging-boxes"

  categoryName String

  // Production specs

  minOrderQuantity Int // Category-specific MOQ

  maxOrderQuantity Int?

  leadTimeDays Int // Days to produce

  // Pricing (indicative)

  pricePerUnitMin Int? // In kobo, minimum price

  pricePerUnitMax Int? // In kobo, maximum price

  // Notes

  notes String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@unique([factoryId, categorySlug])
  @@index([factoryId])
  @@index([categorySlug])
}

model FactoryComplianceDoc {
  id String @id @default(cuid())

  factory FactoryProfile @relation(fields: [factoryId], references: [id])

  factoryId String

  // Document details

  docType String // e.g., "TRADE_LICENSE", "ISO_CERT", "FIRE_SAFETY"

  docName String

  fileUrl String

  // Verification

  isVerified Boolean @default(false)

  verifiedByAdminId String?

  verifiedAt DateTime?

  rejectionReason String?

  expiryDate DateTime?

  uploadedAt DateTime @default(now())

  @@index([factoryId])
  @@index([docType])
}

model FactoryProduction {
  id String @id @default(cuid())

  // Link to order

  order Order @relation(fields: [orderId], references: [id])

  orderId String @unique

  // Link to factory

  factory FactoryProfile @relation(fields: [factoryId], references: [id])

  factoryId String

  // Production status

  status ProductionStatus @default(NOT_STARTED)

  // Timeline

  expectedStartDate DateTime?

  actualStartDate DateTime?

  expectedEndDate DateTime?

  actualEndDate DateTime?

  // Quantity

  orderedQuantity Int

  producedQuantity Int @default(0)

  defectQuantity Int @default(0)

  // Updates (JSON array of status updates)

  updates Json? // [{ status, note, timestamp, updatedBy }]

  // Photos (production progress)

  progressPhotos String[] @default([])

  // Quality check

  qcPassed Boolean?

  qcNotes String?

  qcDate DateTime?

  // Handoff

  readyForPickupAt DateTime?

  shippedAt DateTime?

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([factoryId])
  @@index([status])
}
